<template>
  <div>
    <h2 class="text-xl pb-4 pl-10 pt-4 md:pt-0">ç»¼åˆé…ç½®</h2>
    <div class="w-full lg:w-[500px] md:ml-10">
      <el-form
        ref="formRef"
        :model="form"
        layout="vertical"
        label-position="top"
        size="large"
        v-loading="loading"
      >
        <el-divider content-position="left">äº®è‰²ä¸»é¢˜ Logo</el-divider>
        <el-form-item prop="light_logo" label="äº®è‰²ä¸»é¢˜ Logo">
          <el-input v-model="form.light_logo" placeholder="è¯·è¾“å…¥äº®è‰²Logoåœ°å€">
            <template #prefix>
              <Image class="w-4 h-4" />
            </template>
            <template #append>
              <CloudUpload class="cursor-pointer" @click="handleUpload('light_logo')" />
            </template>
          </el-input>
        </el-form-item>
        <img :src="form.light_logo" alt="" class="w-1/3 mt-4 rounded" />

        <el-divider content-position="left">æš—è‰²ä¸»é¢˜ Logo</el-divider>
        <el-form-item prop="dark_logo" label="æš—è‰²ä¸»é¢˜ Logo">
          <el-input v-model="form.dark_logo" placeholder="è¯·è¾“å…¥æš—è‰²Logoåœ°å€">
            <template #prefix>
              <Image class="w-4 h-4" />
            </template>
            <template #append>
              <CloudUpload class="cursor-pointer" @click="handleUpload('dark_logo')" />
            </template>
          </el-input>
        </el-form-item>
        <img :src="form.dark_logo" alt="" class="w-1/3 mt-4 rounded" />

        <el-divider content-position="left">ä½œè€…å¡ç‰‡èƒŒæ™¯</el-divider>
        <el-form-item prop="author_bg" label="ä½œè€…å¡ç‰‡èƒŒæ™¯å›¾">
          <el-input v-model="form.author_bg" placeholder="è¯·è¾“å…¥èƒŒæ™¯å›¾åœ°å€">
            <template #prefix>
              <Image class="w-4 h-4" />
            </template>
            <template #append>
              <CloudUpload class="cursor-pointer" @click="handleUpload('author_bg')" />
            </template>
          </el-input>
        </el-form-item>
        <img :src="form.author_bg" alt="" class="w-1/3 mt-4 rounded" />

        <el-divider content-position="left">ä½œè€…ä¿¡æ¯</el-divider>
        <el-form-item prop="author_avatar" label="ä½œè€…å¤´åƒ">
          <el-input v-model="form.author_avatar" placeholder="è¯·è¾“å…¥ä½œè€…å¤´åƒåœ°å€">
            <template #prefix>
              <Image class="w-4 h-4" />
            </template>
            <template #append>
              <CloudUpload class="cursor-pointer" @click="handleUpload('author_avatar')" />
            </template>
          </el-input>
        </el-form-item>
        <img
          :src="form.author_avatar"
          alt=""
          class="w-20 h-20 rounded-full mt-2 object-cover border"
          v-if="form.author_avatar"
        />

        <el-form-item prop="record_name" label="ä½œè€…æ˜µç§°">
          <el-input v-model="form.record_name" placeholder="è¯·è¾“å…¥ä½œè€…æ˜µç§° (å¦‚: ğŸ‘‹ OHH)" />
        </el-form-item>
        <el-form-item prop="record_info" label="ä¸ªæ€§ç­¾å">
          <el-input v-model="form.record_info" placeholder="è¯·è¾“å…¥ä¸ªæ€§ç­¾å" />
        </el-form-item>

        <el-divider content-position="left">æ–‡ç« åˆ—è¡¨å°é¢</el-divider>
        <el-form-item prop="covers" label="æ–‡ç« åˆ—è¡¨å°é¢ (ä¾§è¾¹æ è½®æ’­)">
          <el-input
            v-model="form.covers"
            type="textarea"
            :autosize="{ minRows: 3, maxRows: 6 }"
            placeholder="è¯·è¾“å…¥å°é¢å›¾ç‰‡åœ°å€"
          />
          <el-alert
            title="ä»¥æ¢è¡Œåˆ†éš”ï¼Œæ¯è¡Œä¸€å¼ å›¾ç‰‡åœ°å€ã€‚å¦‚æœæ–‡ç« æ²¡æœ‰å°é¢ï¼Œå°†ä»ä¸­éšæœºé€‰å–ä¸€å¼ ä½œä¸ºå°é¢ã€‚"
            type="info"
            :closable="false"
            class="mt-2"
          />
        </el-form-item>

        <el-divider content-position="left">é¦–é¡µèƒŒæ™¯å›¾</el-divider>
        <el-form-item prop="swiper_image" label="é¦–é¡µèƒŒæ™¯å›¾">
          <el-input v-model="form.swiper_image" placeholder="è¯·è¾“å…¥èƒŒæ™¯å›¾åœ°å€">
            <template #prefix>
              <Image class="w-4 h-4" />
            </template>
            <template #append>
              <CloudUpload class="cursor-pointer" @click="handleUpload('swiper_image')" />
            </template>
          </el-input>
        </el-form-item>
        <img :src="form.swiper_image" alt="" class="w-1/3 mt-4 rounded" />

        <el-divider content-position="left">æ‰“å­—æœºæ–‡æœ¬</el-divider>
        <el-form-item prop="swiper_text" label="æ‰“å­—æœºæ–‡æœ¬">
          <el-input
            v-model="form.swiper_text"
            type="textarea"
            :autosize="{ minRows: 2, maxRows: 4 }"
            placeholder="è¯·è¾“å…¥æ‰“å­—æœºæ–‡æœ¬"
          />
          <el-alert
            title="ä»¥æ¢è¡Œåˆ†éš”ï¼Œæ¯è¡Œè¡¨ç¤ºä¸€æ®µæ–‡æœ¬"
            type="info"
            :closable="false"
            class="mt-2"
          />
        </el-form-item>

        <el-divider content-position="left">ç¤¾äº¤ç½‘ç«™</el-divider>
        <el-form-item prop="social" label="ç¤¾äº¤ç½‘ç«™">
          <el-input
            v-model="form.social"
            type="textarea"
            :autosize="{ minRows: 2, maxRows: 4 }"
            placeholder="è¯·è¾“å…¥ç¤¾äº¤ç½‘ç«™"
          />
          <el-alert
            title="è¯·åŠ¡å¿…ç¡®ä¿æ¯ä¸€é¡¹æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç½‘ç«™æ— æ³•è®¿é—®"
            type="info"
            :closable="false"
            class="mt-2"
          />
        </el-form-item>

        <el-divider content-position="left">æ–‡ç« å¸ƒå±€</el-divider>
        <div class="overflow-auto w-full">
          <div class="flex w-[650px]">
            <div
              v-for="item in ['classics', 'card', 'waterfall']"
              :key="item"
              @click="form.is_article_layout = item"
              class="flex flex-col items-center p-4 m-4 border-2 rounded cursor-pointer transition-colors"
              :class="
                form.is_article_layout === item
                  ? 'border-primary'
                  : 'border-gray-200 dark:border-strokedark'
              "
            >
              <p
                class="text-center mb-2"
                :class="form.is_article_layout === item ? 'text-primary' : ''"
              >
                {{ item === 'classics' ? 'ç»å…¸å¸ƒå±€' : item === 'card' ? 'å¡ç‰‡å¸ƒå±€' : 'ç€‘å¸ƒæµå¸ƒå±€' }}
              </p>
              <img :src="getImg(item)" class="w-[200px] bg-gray-100 rounded" />
            </div>
          </div>
        </div>

        <el-button
          type="primary"
          size="large"
          class="w-full mt-4"
          :loading="btnLoading"
          @click="onSubmit"
          >ä¿å­˜</el-button
        >
      </el-form>
    </div>

    <Material
      :open="isMaterialModalOpen"
      @close="isMaterialModalOpen = false"
      @select="handleMaterialSelect"
    />
  </div>
</template>

<script lang="ts">
export default {
  name: 'SynthesisTheme',
}
</script>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { Image, CloudUpload } from 'lucide-vue-next'
import { ElMessage } from 'element-plus'
import Material from '@/components/Material/index.vue'
import { getWebConfigDataAPI, editWebConfigDataAPI } from '@/api/config'
import type { Theme } from '@/types/app/config'
import cardImg from '../../image/card.png'
import classicsImg from '../../image/classics.png'
import waterfallImg from '../../image/waterfall.png'

const loading = ref(false)
const btnLoading = ref(false)
const isMaterialModalOpen = ref(false)
const currentUploadType = ref<keyof Theme | ''>('')
const theme = ref<Theme>({} as Theme)

const form = reactive({
  light_logo: '',
  dark_logo: '',
  swiper_image: '',
  swiper_text: '',
  social: '',
  covers: '',
  record_name: '',
  record_info: '',
  reco_article: '',
  author_bg: '',
  author_avatar: '',
  right_sidebar: [] as string[],
  is_article_layout: '',
})

const getImg = (name: string) => {
  switch (name) {
    case 'card':
      return cardImg
    case 'classics':
      return classicsImg
    case 'waterfall':
      return waterfallImg
    default:
      return ''
  }
}

const getLayoutData = async () => {
  loading.value = true
  try {
    const { data } = await getWebConfigDataAPI<{ value: Theme }>('theme')
    theme.value = data.value
    const t = data.value

    form.light_logo = t.light_logo || 'https://bu.dusays.com/2026/02/06/6985b746c93fd.png'
    form.dark_logo = t.dark_logo || 'https://bu.dusays.com/2026/02/07/6987190aeee4d.png'
    form.swiper_image = t.swiper_image
    form.author_bg = t.author_bg || 'https://bu.dusays.com/2026/02/04/698346b16d065.jpg'
    form.swiper_text = t.swiper_text.join('\n')
    form.record_name = t.record_name || ''
    form.record_info = t.record_info || ''
    form.author_avatar = (t as any).author_avatar || ''
    // Ensure social items are handled correctly regardless of type definitions
    form.social = t.social.map((item: unknown) => JSON.stringify(item)).join('\n')

    // å¦‚æœæ²¡æœ‰é…ç½®å°é¢ï¼Œæˆ–è€…æ˜¯é»˜è®¤å°é¢ï¼ˆè¿™é‡Œç®€å•åˆ¤æ–­é•¿åº¦ï¼‰ï¼Œåˆ™ä½¿ç”¨æ–°æä¾›çš„å°é¢
    // å®é™…ä¸Šç”¨æˆ·å¸Œæœ›å¡«å…¥è¿™äº›é“¾æ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼˜å…ˆä½¿ç”¨æä¾›çš„é“¾æ¥å¡«å……ï¼ˆå› ä¸ºè¿™æ˜¯åˆå§‹åŒ–è¿‡ç¨‹ï¼‰
    // ä½†ä¸ºäº†ä¸è¦†ç›–ç”¨æˆ·å¯èƒ½å·²ç»ä¿å­˜çš„ä¿®æ”¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ || é€»è¾‘ï¼Œæˆ–è€…æ£€æŸ¥æ˜¯å¦ä¸ºç©º/é»˜è®¤
    // é‰´äºè¿™æ˜¯ä¸€ä¸ªâ€œåˆå§‹åŒ–é…ç½®â€çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å‡è®¾å¦‚æœ t.covers ä¸ºç©ºæˆ–è€…åªæœ‰é»˜è®¤å€¼ï¼Œæˆ‘ä»¬è¿½åŠ æˆ–æ›¿æ¢
    const providedCovers = [
      'https://bu.dusays.com/2026/02/04/698346c017609.jpg',
      'https://bu.dusays.com/2026/02/04/698346b4ee9f4.png',
      'https://bu.dusays.com/2026/02/04/698346b3e9880.png',
      'https://bu.dusays.com/2026/02/04/698346b2163ae.jpg',
      'https://bu.dusays.com/2026/02/04/698346b2079d6.jpg',
      'https://bu.dusays.com/2026/02/04/698346b17c425.png',
      'https://bu.dusays.com/2026/02/04/698346b17d6e5.jpg',
      'https://bu.dusays.com/2026/02/04/698346b16d065.jpg',
      'https://bu.dusays.com/2026/02/04/698346b1530ec.jpg',
      'https://bu.dusays.com/2026/02/04/698346b1404a4.jpg',
    ].join('\n')

    form.covers = t.covers.length > 0 ? t.covers.join('\n') : providedCovers
    if (form.covers.length < 50) {
      // ç®€å•çš„å¯å‘å¼ï¼šå¦‚æœå†…å®¹å¤ªçŸ­ï¼Œå¯èƒ½æ˜¯ç©ºçš„æˆ–é»˜è®¤çš„ï¼Œå¼ºåˆ¶å¡«å……ä¸€ä¸‹ä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°
      form.covers = providedCovers
    }

    form.reco_article = t.reco_article?.join('\n') || ''
    form.right_sidebar = t.right_sidebar || []
    form.is_article_layout = t.is_article_layout
  } catch (e) {
    console.error(e)
  } finally {
    loading.value = false
  }
}

const onSubmit = async () => {
  try {
    btnLoading.value = true
    const updatedTheme = {
      ...theme.value,
      ...form,
      social: form.social.split('\n').map((item: string) => JSON.parse(item)),
      swiper_text: form.swiper_text.split('\n'),
      covers: form.covers.split('\n'),
      reco_article: form.reco_article.split('\n'),
    }

    await editWebConfigDataAPI('theme', updatedTheme)
    ElMessage.success('ğŸ‰ ä¿®æ”¹ä¸»é¢˜æˆåŠŸ')
    theme.value = updatedTheme
  } catch (e) {
    console.error(e)
  } finally {
    btnLoading.value = false
  }
}

const handleUpload = (type: string) => {
  currentUploadType.value = type as keyof Theme
  isMaterialModalOpen.value = true
}

const handleMaterialSelect = (urls: string[]) => {
  if (currentUploadType.value) {
    if (Object.keys(form).includes(currentUploadType.value)) {
      // @ts-expect-error key access
      form[currentUploadType.value] = urls[0]
    }
    // @ts-expect-error key access
    theme.value[currentUploadType.value] = urls[0]
  }
}

onMounted(() => {
  getLayoutData()
})
</script>
